#-----------------------------
# ALD_PH
#-----------------------------
#purpose:
#Extract data from PAH database with publicly available aggregate level data 
# in the file Quantify PAH Clinical Outcomes Database 20200818_oldformat_final.xlsx

# This code will generate data.frame-object datnmaL_cw1 which stores longitudinal data
# for time to clinical worsening composite endpoint event probabilities 
# for PAH trials with long-term follow-up and interventional drug coming from the ERA-drug class.

# Note: two important Actelion trials are not in this dataset, 
# because they used a drug intervention from the prostacyclin-analog pathway (selexipag).

#author: RSauter1
#last edit: 12/05/2020
#================================================
#Content:
#----------


#================================================
#clean workspace:
rm(list=ls())

#change wd !!!
setwd("C:/Users/Rsauter1/OneDrive - JNJ/Documents/PhD_intern/PhDProject_package/")

#Directories:
proj_dir <- getwd()
setwd(proj_dir)
#Directory with programs:
code_dir <- file.path(proj_dir, "program")
#Data-directory with own DB:
data_dir <- file.path(proj_dir, "data")


#Libraries
#--------------
library(ggplot2)
library(readxl)
library(tidyverse)

#Source functions
#----------------
source(file.path(code_dir, "Rfunctions.R"))
source(file.path(code_dir, "DataAlteration.R"))
source(file.path(code_dir,"DataAdditions.R"))


#Extract Certara DB data (as defined by endpoint arguments)
#----------------

#Extract_CertaraDB_developArguments.R purpose: 
# goes through 19 trials (available in the Certara dataset) and 
# assesses / lists the relevant arguments to extract the 6mwd, CW, death, hospitalization pah, progression endpoints.
# Endpoints are extracted for the reported follow-up time point only and **NOT** longitudinally!
# The extraction relies on some wrapper functions defined in ~/NMA_inR/program/Rfunctions.R.
# The Extract_CertaraDB_developArguments.R only needs to be executed once, as 
# extraction arguments will be saved in output "ExtractionArguments.csv".
# After that Extract_CertaraDB.R can be used (which relies on "ExtractionArguments.csv").
# Check the output "ExtractionArguments.csv" to see data-sources for each extracted endpoint.

# source(file.path(code_dir, "Extract_CertaraDB_developArguments.R"))
# source(file.path(code_dir, "Extract_CertaraDB_developArgumentsLongitudinal.R"))


#Subset data using derived extraction-arugments: (this is done without objects/arguments which are obsolete.)
source(file.path(code_dir, "Extract_CertaraDB_Longitudinal.R"))

# Data Alterations
#---------------
#applies some changes / corrections to datapoints: (placebo replaced with required background therapy, time.exposure in COMPASSS-2)
datnmaL_cw <- DataAlteration(datnmaL_cw)
#Additions
#---------------
#computes incidence rate, odds and incidence rate ratios with standad error and CI.
datnmaL_cw <- DataAdditions(datnmaL_cw, addBinary=FALSE)




#Plot CW for all trials
ggplot(aes(x=time, y=value, group=treatment.label, col=endpoint.source), 
       data=datnmaL_cw)+
  geom_point(shape=15)+facet_wrap(~treatment.label+trial)



#Subset data.frame to relevant, used variables:
selNam <- c("p", "value","active","time","lgtime","n.endpoint","n.observed","n.randomized", "time.group","relDose",
            "trialstrata","trialstrata.arm","arm","drug1","trial","trial.year.start", "endpoint.source", "treatment.label",
             "backTxperc")
#check
# selNam[which(!selNam%in%names(datnmaL_cw))]
datnmaL_cw1 <- datnmaL_cw[, selNam]

#Select long-term trials:
selTrials <- c("ac-052-414/compass-2","seraphin", "ambition", "aries-e")

datnmaL_cw1 <- datnmaL_cw1[which(datnmaL_cw1$trial%in%selTrials),]

ggplot(aes(x=time, y=value, group=treatment.label, col=endpoint.source), 
       data=datnmaL_cw1)+
  geom_point(shape=15)+facet_wrap(~treatment.label+trial)

# Value: is the probability of event at specified time point (time). 
# Datapoints were extracted from published Kaplan Meier figures.
write.table(datnmaL_cw1, file.path(data_dir, "datnmaL_cw1.csv"), sep=";", row.names=FALSE)
#
